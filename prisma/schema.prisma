// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User authentication
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String?
  isAdmin       Boolean  @default(false)
  credits       Int      @default(3) // Custom story generation credits
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  sessions        Session[]
  favorites       Favorite[]
  customStories   Story[]  @relation("UserCustomStories")
  readingHistory  ReadingHistory[]
}

// Session management for JWT alternative
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Romance stories
model Story {
  id                String           @id @default(cuid())
  title             String           @default("Generating...")
  summary           String           @default("Story is being generated")
  content           String           @default("")
  coverImage        String?
  author            String           @default("AI Generated")
  genre             String
  tags              String?
  readingTime       Int?
  ageRating         String           @default("PG-13")
  published         Boolean          @default(false)
  featured          Boolean          @default(false)
  viewCount         Int              @default(0)
  generationStatus  GenerationStatus @default(PENDING)
  generationError   String?

  // Custom generation fields
  isCustom          Boolean          @default(false) // True if user-generated, false if admin curated
  userId            String?          // User who created this custom story (null for curated stories)
  characterNames    String?          // JSON string of custom character names {"protagonist": "name", "love_interest": "name"}
  customScenario    String?          // Optional plot/scenario request from user

  // Story extensions
  parentStoryId     String?          // If this is an extension, the ID of the parent story
  chapterNumber     Int              @default(1) // 1 for original, 2+ for extensions

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  favorites         Favorite[]
  readingHistory    ReadingHistory[]
  creator           User?            @relation("UserCustomStories", fields: [userId], references: [id], onDelete: SetNull)
  parentStory       Story?           @relation("StoryExtensions", fields: [parentStoryId], references: [id], onDelete: SetNull)
  extensions        Story[]          @relation("StoryExtensions")

  @@index([genre])
  @@index([published])
  @@index([featured])
  @@index([generationStatus])
  @@index([userId])
  @@index([isCustom])
  @@index([parentStoryId])
}

enum GenerationStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

// User favorites/bookmarks
model Favorite {
  id        String   @id @default(cuid())
  userId    String
  storyId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([userId, storyId]) // Prevent duplicate favorites
  @@index([userId])
  @@index([storyId])
}

// Reading history for "Recently Read" feature
model ReadingHistory {
  id          String   @id @default(cuid())
  userId      String
  storyId     String
  lastReadAt  DateTime @default(now())
  progress    Float    @default(0) // 0-100 percentage read

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([userId, storyId])
  @@index([userId, lastReadAt])
  @@index([storyId])
}
