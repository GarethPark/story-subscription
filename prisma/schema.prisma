// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User authentication
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String?
  isAdmin       Boolean  @default(false)
  credits       Int      @default(3) // Custom story generation credits
  creditsUsed   Int      @default(0) // Total credits used for analytics
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Stripe subscription fields
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?   // Current price ID
  stripeCurrentPeriodEnd DateTime? // When subscription period ends
  subscriptionTier       SubscriptionTier @default(FREE)
  monthlyCredits         Int       @default(0)  // Credits allocated per month for subscription
  creditsResetAt         DateTime? // When monthly credits reset

  // Relations
  sessions              Session[]
  favorites             Favorite[]
  customStories         Story[]  @relation("UserCustomStories")
  readingHistory        ReadingHistory[]
  ratings               Rating[]
  reviews               Review[]
  feedback              Feedback[]
  subscriptionHistory   SubscriptionHistory[]
  creditTransactions    CreditTransaction[]
}

// Session management for JWT alternative
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Romance stories
model Story {
  id                String           @id @default(cuid())
  title             String           @default("Generating...")
  summary           String           @default("Story is being generated")
  content           String           @default("")
  coverImage        String?
  author            String           @default("AI Generated")
  genre             String
  tags              String?
  readingTime       Int?
  ageRating         String           @default("PG-13")
  published         Boolean          @default(false)
  featured          Boolean          @default(false)
  viewCount         Int              @default(0)
  generationStatus  GenerationStatus @default(PENDING)
  generationError   String?

  // Custom generation fields
  isCustom          Boolean          @default(false) // True if user-generated, false if admin curated
  userId            String?          // User who created this custom story (null for curated stories)
  characterNames    String?          // JSON string of custom character names {"protagonist": "name", "love_interest": "name"}
  customScenario    String?          // Optional plot/scenario request from user

  // Story extensions
  parentStoryId     String?          // If this is an extension, the ID of the parent story
  chapterNumber     Int              @default(1) // 1 for original, 2+ for extensions

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  favorites         Favorite[]
  readingHistory    ReadingHistory[]
  ratings           Rating[]
  reviews           Review[]
  creditTransactions CreditTransaction[]
  creator           User?            @relation("UserCustomStories", fields: [userId], references: [id], onDelete: SetNull)
  parentStory       Story?           @relation("StoryExtensions", fields: [parentStoryId], references: [id], onDelete: SetNull)
  extensions        Story[]          @relation("StoryExtensions")

  @@index([genre])
  @@index([published])
  @@index([featured])
  @@index([generationStatus])
  @@index([userId])
  @@index([isCustom])
  @@index([parentStoryId])
}

enum GenerationStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

// User favorites/bookmarks
model Favorite {
  id        String   @id @default(cuid())
  userId    String
  storyId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([userId, storyId]) // Prevent duplicate favorites
  @@index([userId])
  @@index([storyId])
}

// Reading history for "Recently Read" feature
model ReadingHistory {
  id          String   @id @default(cuid())
  userId      String
  storyId     String
  lastReadAt  DateTime @default(now())
  progress    Float    @default(0) // 0-100 percentage read

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([userId, storyId])
  @@index([userId, lastReadAt])
  @@index([storyId])
}

// Story ratings (1-5 stars)
model Rating {
  id        String   @id @default(cuid())
  userId    String
  storyId   String
  rating    Int      // 1-5 stars
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([userId, storyId]) // One rating per user per story
  @@index([storyId])
  @@index([userId])
}

// Story reviews/comments
model Review {
  id        String   @id @default(cuid())
  userId    String
  storyId   String
  content   String   // Review text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId, createdAt])
  @@index([userId])
}

// User feedback about the platform
model Feedback {
  id        String   @id @default(cuid())
  userId    String?  // Optional - allow anonymous feedback
  name      String?  // For display if user wants
  email     String?  // Contact email
  subject   String?  // Feedback category
  message   String   // Feedback content
  status    FeedbackStatus @default(PENDING)
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
  @@index([userId])
}

enum FeedbackStatus {
  PENDING
  REVIEWED
  RESOLVED
}

// Testimonials for landing page
model Testimonial {
  id        String   @id @default(cuid())
  name      String   // Display name (e.g., "Sarah M.")
  quote     String   // The testimonial text
  impact    String?  // Short impact statement (e.g., "Breathes life back into marriage")
  active    Boolean  @default(true) // Show on landing page
  order     Int      @default(0) // Display order
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active, order])
}

// Subscription tiers
enum SubscriptionTier {
  FREE
  STARTER
  PLUS
  UNLIMITED
}

// Subscription payment history
model SubscriptionHistory {
  id              String   @id @default(cuid())
  userId          String
  tier            SubscriptionTier
  stripeInvoiceId String?
  amount          Int      // in cents
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// Credit transaction log
model CreditTransaction {
  id          String                @id @default(cuid())
  userId      String
  amount      Int                   // positive = added, negative = used
  type        CreditTransactionType
  description String?
  storyId     String?
  createdAt   DateTime              @default(now())

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  story Story? @relation(fields: [storyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
  @@index([type])
}

enum CreditTransactionType {
  PURCHASE         // One-time credit purchase
  SUBSCRIPTION     // Monthly subscription credits
  SIGNUP_BONUS     // Initial signup credits
  ADMIN_GRANT      // Admin manually added credits
  STORY_GENERATION // Credit used for story
  REFUND           // Credit refunded
}
